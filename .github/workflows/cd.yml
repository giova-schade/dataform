name: CD - Dataform (GitHub Flow)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      target_env:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - qa
          - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    environment: ${{ github.event_name == 'push' && 'dev' || inputs.target_env }}

    permissions:
      contents: read
      id-token: write

    env:
      REGION: southamerica-west1
      REPOSITORY_ID: sandbox-dataform

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main   # ðŸ”‘ SIEMPRE se promueve desde main

      - name: Auth GCP (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Set environment variables
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "PROJECT_ID=dataform-480412-dev" >> $GITHUB_ENV
            echo "RELEASE_CONFIG=sandbox-release-dev" >> $GITHUB_ENV
            echo "WORKFLOW_CONFIG=sandbox-workflow-dev" >> $GITHUB_ENV
            echo "DATASET=dataform_dev" >> $GITHUB_ENV
          elif [ "${{ inputs.target_env }}" = "qa" ]; then
            echo "PROJECT_ID=dataform-480412-qa" >> $GITHUB_ENV
            echo "RELEASE_CONFIG=sandbox-release-qa" >> $GITHUB_ENV
            echo "WORKFLOW_CONFIG=sandbox-workflow-qa" >> $GITHUB_ENV
            echo "DATASET=dataform_qa" >> $GITHUB_ENV
          else
            echo "PROJECT_ID=dataform-480412-prod" >> $GITHUB_ENV
            echo "RELEASE_CONFIG=sandbox-release-prod" >> $GITHUB_ENV
            echo "WORKFLOW_CONFIG=sandbox-workflow-prod" >> $GITHUB_ENV
            echo "DATASET=dataform_prod" >> $GITHUB_ENV
          fi

      - name: Create or Update ReleaseConfig
        run: |
          gcloud beta dataform release-configs create ${RELEASE_CONFIG} \
            --project=${PROJECT_ID} \
            --location=${REGION} \
            --repository=${REPOSITORY_ID} \
            --git-commitish=main \
            --code-compilation-config='{
              "defaultDatabase": "'"${PROJECT_ID}"'",
              "defaultSchema": "'"${DATASET}"'",
              "assertionSchema": "'"${DATASET}_assertions"'",
              "vars": {
                "outputDataset": "'"${DATASET}"'"
              }
            }' || echo "ReleaseConfig exists"

      - name: Create or Update WorkflowConfig
        run: |
          gcloud beta dataform workflow-configs create ${WORKFLOW_CONFIG} \
            --project=${PROJECT_ID} \
            --location=${REGION} \
            --repository=${REPOSITORY_ID} \
            --release-config=${RELEASE_CONFIG} || echo "WorkflowConfig exists"
